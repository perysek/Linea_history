{% extends 'base.html' %}

{% block title %}Dane z selekcji - LINEA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/linea.css') }}">
{% endblock %}

{% block content %}
<div class="refined-page fade-in">
    <!-- Page Header -->
    <header class="page-header">
        <h1 class="page-title">Dane z selekcji</h1>
    </header>

    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 1rem;">
            <div style="font-size: 0.6875rem; color: var(--color-ink-subtle); margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Raportów</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-ink);">{{ stats.count }}</div>
        </div>

        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 1rem;">
            <div style="font-size: 0.6875rem; color: var(--color-ink-subtle); margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Detali</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-ink);">{{ "{:,.0f}".format(stats.parts_checked).replace(',', ' ') }}</div>
        </div>

        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 1rem;">
            <div style="font-size: 0.6875rem; color: var(--color-ink-subtle); margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Braków</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-ink);">{{ "{:,.0f}".format(stats.total_defects).replace(',', ' ') }}</div>
        </div>

        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 1rem;">
            <div style="font-size: 0.6875rem; color: var(--color-ink-subtle); margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Brakowość</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-ink);">{{ "%.2f"|format(stats.average_scrap_rate) }}%</div>
        </div>

        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 1rem;">
            <div style="font-size: 0.6875rem; color: var(--color-ink-subtle); margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Wydajność</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-ink);">{{ "%.0f"|format(stats.average_productivity) }}</div>
        </div>

        <div style="background: white; border: 1px solid var(--color-border); border-radius: 8px; padding: 1rem;">
            <div style="font-size: 0.6875rem; color: var(--color-ink-subtle); margin-bottom: 0.25rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em;">Godz. pracy</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: var(--color-ink);">{{ "%.1f"|format(stats.hours_worked) }}</div>
        </div>
    </div>

    <!-- Filter Pills -->
    <div class="filters-container">
        <div class="filter-pills">
            <a href="{{ url_for('placeholder.dane_selekcji', preset='last_week') }}"
               class="filter-pill {% if preset == 'last_week' %}active{% endif %}">Ostatni tydzień</a>
            <a href="{{ url_for('placeholder.dane_selekcji', preset='last_month') }}"
               class="filter-pill {% if preset == 'last_month' %}active{% endif %}">Ostatni miesiąc</a>
            <a href="{{ url_for('placeholder.dane_selekcji', preset='this_month') }}"
               class="filter-pill {% if preset == 'this_month' %}active{% endif %}">Ten miesiąc</a>
            <a href="{{ url_for('placeholder.dane_selekcji', preset='previous_month') }}"
               class="filter-pill {% if preset == 'previous_month' %}active{% endif %}">Poprzedni miesiąc</a>
            <a href="{{ url_for('placeholder.dane_selekcji', preset='last_quarter') }}"
               class="filter-pill {% if preset == 'last_quarter' %}active{% endif %}">Ostatni kwartał</a>
            <a href="{{ url_for('placeholder.dane_selekcji', preset='this_year') }}"
               class="filter-pill {% if preset == 'this_year' %}active{% endif %}">Ten rok</a>
            <a href="{{ url_for('placeholder.dane_selekcji', preset='all') }}"
               class="filter-pill {% if preset == 'all' %}active{% endif %}">Wszystko</a>
        </div>
    </div>

    <!-- Table Container -->
    <div class="table-container">
        <div class="table-scroll-wrapper">
            <table class="refined-table">
                <colgroup>
                    <col style="width: 8%;">   <!-- DATA -->
                    <col style="width: 8%;">   <!-- DZIAŁ -->
                    <col style="width: 8%;">   <!-- RAPORT -->
                    <col style="width: 9%;">   <!-- NR NC -->
                    <col style="width: 8%;">   <!-- DATA NC -->
                    <col style="width: 8%;">   <!-- ZAM -->
                    <col style="width: 10%;">  <!-- KOD DETALU -->
                    <col style="width: 8%;">   <!-- INSTRUKCJA -->
                    <col style="width: 6%;">   <!-- ONLINE -->
                    <col style="width: 8%;">   <!-- ILOŚĆ -->
                    <col style="width: 5%;">   <!-- NOK -->
                    <col style="width: 10%;">  <!-- WADY -->
                    <col style="width: 6%;">   <!-- BRAKI % -->
                    <col style="width: 6%;">   <!-- CZAS -->
                    <col style="width: 6%;">   <!-- szt/godz -->
                </colgroup>
                <thead>
                    <tr>
                        <th class="sortable">
                            <div class="th-content">
                                <div class="th-header" onclick="sortColumn('data_selekcji')" style="cursor: pointer;">
                                    DATA
                                    <span class="sort-icon">{{ '▼' if sort_by == 'data_selekcji' and order == 'desc' else '▲' if sort_by == 'data_selekcji' else '' }}</span>
                                </div>
                            </div>
                        </th>
                        <th>DZIAŁ</th>
                        <th class="sortable">
                            <div class="th-content">
                                <div class="th-header" onclick="sortColumn('nr_raportu')" style="cursor: pointer;">
                                    RAPORT
                                    <span class="sort-icon">{{ '▼' if sort_by == 'nr_raportu' and order == 'desc' else '▲' if sort_by == 'nr_raportu' else '' }}</span>
                                </div>
                                <input type="text" class="search-input" placeholder="szukaj...">
                            </div>
                        </th>
                        <th class="sortable">
                            <div class="th-content">
                                <div class="th-header" onclick="sortColumn('nr_niezgodnosci')" style="cursor: pointer;">
                                    NR NC
                                    <span class="sort-icon">{{ '▼' if sort_by == 'nr_niezgodnosci' and order == 'desc' else '▲' if sort_by == 'nr_niezgodnosci' else '' }}</span>
                                </div>
                                <input type="text" class="search-input" placeholder="szukaj...">
                            </div>
                        </th>
                        <th class="sortable">
                            <div class="th-content">
                                <div class="th-header" onclick="sortColumn('data_niezgodnosci')" style="cursor: pointer;">
                                    DATA NC
                                    <span class="sort-icon">{{ '▼' if sort_by == 'data_niezgodnosci' and order == 'desc' else '▲' if sort_by == 'data_niezgodnosci' else '' }}</span>
                                </div>
                            </div>
                        </th>
                        <th>ZAM</th>
                        <th>KOD DETALU</th>
                        <th>INSTR</th>
                        <th style="text-align: center;">ONLINE</th>
                        <th style="text-align: right;">ILOŚĆ</th>
                        <th style="text-align: right;">NOK</th>
                        <th>WADY</th>
                        <th style="text-align: right;">BRAKI %</th>
                        <th style="text-align: right;">CZAS</th>
                        <th style="text-align: right;">szt/h</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reports %}
                        {% for report in reports %}
                        <tr>
                            <td style="font-size: 0.6875rem;">{{ report.data_selekcji.strftime('%d.%m.%y') if report.data_selekcji else '-' }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.operator.dzial.opis_kategorii if report.operator and report.operator.dzial else '-' }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.nr_raportu }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.nr_niezgodnosci }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.data_niezgodnosci.strftime('%d.%m.%y') if report.data_niezgodnosci else '-' }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.nr_zamowienia or '-' }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.kod_detalu or '-' }}</td>
                            <td style="font-size: 0.6875rem;">{{ report.nr_instrukcji or '-' }}</td>
                            <td style="text-align: center; font-size: 0.6875rem;">
                                {% if report.selekcja_na_biezaco %}
                                <span style="display: inline-block; padding: 0.125rem 0.5rem; background: #dcfce7; color: #166534; border-radius: 999px; font-size: 0.625rem; font-weight: 500;">Tak</span>
                                {% else %}
                                <span style="display: inline-block; padding: 0.125rem 0.5rem; background: var(--color-border-subtle); color: var(--color-ink-muted); border-radius: 999px; font-size: 0.625rem; font-weight: 500;">Nie</span>
                                {% endif %}
                            </td>
                            <td style="text-align: right; font-weight: 500; font-size: 0.6875rem;">{{ "{:,.0f}".format(report.ilosc_detali_sprawdzonych).replace(',', ' ') }}</td>
                            <td style="text-align: right; font-size: 0.6875rem;">
                                {% if report.total_defects > 0 %}
                                <span style="color: #f59e0b; font-weight: 500;">{{ report.total_defects }}</span>
                                {% else %}
                                <span style="color: var(--color-ink-subtle);">0</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 0.625rem;">
                                {% if report.braki_defekty %}
                                {{ report.braki_defekty|map(attribute='defekt')|join(', ') }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td style="text-align: right; font-size: 0.6875rem;">
                                {% if report.ilosc_detali_sprawdzonych > 0 %}
                                    {% set scrap_percentage = (report.total_defects / report.ilosc_detali_sprawdzonych) * 100 %}
                                    {% if scrap_percentage >= 5 %}
                                    <span style="color: #ef4444; font-weight: 600;">{{ "%.1f"|format(scrap_percentage) }}</span>
                                    {% elif scrap_percentage >= 2 %}
                                    <span style="color: #f59e0b; font-weight: 500;">{{ "%.1f"|format(scrap_percentage) }}</span>
                                    {% elif scrap_percentage > 0 %}
                                    <span style="color: #10b981;">{{ "%.1f"|format(scrap_percentage) }}</span>
                                    {% else %}
                                    <span style="color: var(--color-ink-subtle);">0.0</span>
                                    {% endif %}
                                {% else %}
                                <span style="color: var(--color-ink-subtle);">-</span>
                                {% endif %}
                            </td>
                            <td style="text-align: right; font-size: 0.6875rem;">{{ "%.1f"|format(report.czas_pracy) }}</td>
                            <td style="text-align: right; font-size: 0.6875rem;">{{ "%.0f"|format(report.rzeczywista_wydajnosc) }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 3rem; color: var(--color-ink-subtle);">
                            <div style="font-size: 1rem; margin-bottom: 0.5rem;">Brak danych</div>
                            <div style="font-size: 0.75rem;">Brak raportów selekcji dla wybranego okresu</div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function sortColumn(column) {
    const params = new URLSearchParams(window.location.search);
    const currentSort = params.get('sort');
    const currentOrder = params.get('order') || 'asc';

    if (currentSort === column) {
        params.set('order', currentOrder === 'asc' ? 'desc' : 'asc');
    } else {
        params.set('sort', column);
        params.set('order', 'desc');
    }

    window.location.search = params.toString();
}
</script>
{% endblock %}
